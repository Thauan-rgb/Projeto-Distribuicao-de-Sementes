<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Semeia Web - Estoque</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --cor-primaria: #2e7d32;
      --cor-secundaria: #4caf50;
      --cor-fundo: #f4f6f5;
      --texto-principal: #333;
      --branco: #fff;
    }

    body {
      background-color: #f5f7f5;
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
    }

    /* ===== Sidebar ===== */
    .sidebar {
      width: 250px;
      height: 100vh;
      background-color: #146c43;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 10px;
      position: fixed;
      transition: width 0.3s ease;
      overflow: hidden;
    }

    .sidebar.collapsed { width: 80px; }

    .toggler {
      font-size: 1.5rem;
      cursor: pointer;
      color: #fff;
      align-self: flex-start;
      margin-bottom: 15px;
      margin-left: 5px;
      transition: all 0.3s ease;
    }

    .sidebar.collapsed .toggler {
      align-self: center;
      margin: 15px 0;
    }

    .toggler:hover { transform: scale(1.1); }

    .logo {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }

    .logo img { width: 45px; transition: all 0.3s ease; }
    .logo h4 { margin: 8px 0 0 0; color: #fff; transition: opacity 0.3s ease; }

    .sidebar.collapsed .logo h4 {
      opacity: 0;
      height: 0;
      overflow: hidden;
    }

    .profile {
      text-align: center;
      margin-bottom: 30px;
      transition: all 0.3s ease;
    }

    .profile img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 2px solid white;
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }

    .sidebar.collapsed .profile img {
      width: 45px;
      height: 45px;
    }

    .sidebar.collapsed .profile h6 {
      display: none;
    }

    .sidebar a {
      color: white;
      text-decoration: none;
      width: 100%;
      padding: 12px 20px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.3s ease, padding 0.3s ease;
    }

    .sidebar a:hover,
    .sidebar a.active { background-color: #0d5032; }

    .sidebar.collapsed a {
      justify-content: center;
      padding: 12px 0;
    }

    .sidebar.collapsed a span { display: none; }

    .logout {
      margin-top: auto;
      width: 100%;
      border-top: 1px solid rgba(255,255,255,0.2);
      padding-top: 15px;
    }

    .logout a {
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      border-radius: 10px;
      transition: background 0.3s ease;
    }

    .logout a:hover { background-color: #0d5032; }

    .sidebar.collapsed .logout a {
      justify-content: center;
      padding: 12px 0;
    }

    .sidebar.collapsed .logout a span { display: none; }

    /* ===== Main Content ===== */
    .main-content {
      margin-left: 250px;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transition: margin-left 0.3s ease, width 0.3s ease;
      width: calc(100% - 250px);
    }

    .sidebar.collapsed ~ .main-content {
      margin-left: 80px;
      width: calc(100% - 80px);
    }

    header {
      background-color: var(--branco);
      padding: 15px 25px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h4 { 
      margin: 0; 
      color: var(--texto-principal);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-info img {
      width: 35px;
      height: 35px;
      border-radius: 50%;
    }

    main {
      flex: 1;
      padding: 40px 25px;
      background-color: var(--cor-fundo);
    }

    /* ===== Conteúdo Estoque ===== */
    h2 {
      color: #146c43;
      font-weight: 600;
      margin-bottom: 30px;
    }

    .estoque-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 25px;
    }

    .estoque-card h4 {
      color: #146c43;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .estoque-card ul {
      list-style: none;
      padding-left: 0;
      margin-bottom: 15px;
    }

    .estoque-card li::before {
      content: "• ";
      color: #146c43;
      font-weight: bold;
    }

    .btn-adicionar {
      background-color: #146c43;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      transition: 0.3s;
    }

    .btn-adicionar:hover {
      background-color: #0d5032;
    }

    /* Novos estilos para os botões de ação */
    .estoque-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .btn-editar {
      background-color: #ffc107;
      color: #212529;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      transition: 0.3s;
    }

    .btn-editar:hover {
      background-color: #e0a800;
    }

    .btn-buscar {
      background-color: #17a2b8;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      transition: 0.3s;
    }

    .btn-buscar:hover {
      background-color: #138496;
    }

    .btn-deletar {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      transition: 0.3s;
    }

    .btn-deletar:hover {
      background-color: #c82333;
    }

    /* Estilo para as barras de busca individuais */
    .search-container {
      margin-bottom: 15px;
      display: none;
    }

    .search-input {
      border-radius: 8px;
      border: 1px solid #ddd;
      padding: 8px 15px;
      width: 100%;
      max-width: 400px;
    }

    /* Estilo para os modais */
    .modal-header {
      background-color: #146c43;
      color: white;
    }

    .modal-footer {
      border-top: 1px solid #dee2e6;
    }

    /* Estilo para os itens da lista com botões de ação */
    .estoque-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .estoque-item:last-child {
      border-bottom: none;
    }

    .item-actions {
      display: flex;
      gap: 5px;
    }

    .item-actions button {
      padding: 4px 8px;
      font-size: 0.8rem;
    }

    /* Estilo para remessas */
    .remessa-info {
      display: flex;
      flex-direction: column;
    }

    .remessa-lote {
      font-weight: bold;
      color: #146c43;
    }

    .remessa-detalhes {
      font-size: 0.85rem;
      color: #666;
    }

    /* Loading spinner */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #146c43;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .sem-remessas {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 20px 0;
    }
  </style>
</head>
<body>

  <!-- ===== Sidebar ===== -->
  <div class="sidebar" id="sidebar">
    <i class="bi bi-list toggler" id="toggle-btn"></i>

    <div class="logo">
      <img src="img/logo2.png" alt="Semeia Web">
      <h4>Semeia Web</h4>
    </div>

    <div class="profile">
      <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Usuário">
      <h6>Annatoli Karpov Bartolomeu</h6>
    </div>

    <a href="dashboard_gerente.html"><i class="bi bi-house-fill"></i><span>Início</span></a>
    <a href="estoque.html" class="active"><i class="bi bi-box-seam"></i><span>Estoque</span></a>
    <a href="distribuicao.html"><i class="bi bi-truck"></i><span>Distribuição</span></a>
    <a href="relatorios.html"><i class="bi bi-bar-chart-line"></i><span>Relatórios</span></a>
    <a href="usuarios.html"><i class="bi bi-people"></i><span>Usuários</span></a>
    <a href="notificacoes.html"><i class="bi bi-bell"></i><span>Notificações</span></a>
    <a href="configuracao.html"><i class="bi bi-gear"></i><span>Configurações</span></a>

    <div class="logout">
      <a href="../login.html"><i class="bi bi-box-arrow-right"></i><span>Sair</span></a>
    </div>
  </div>

  <!-- ===== Conteúdo Principal ===== -->
  <div class="main-content" id="main-content">
    <header>
      <h4>Controle de Estoque</h4>
      <div class="user-info">
        <span>Bem-vindo, Annatoli</span>
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Usuário">
      </div>
    </header>

    <main>
      <div class="container-fluid">
        <h2>Situação Atual dos Estoques</h2>

        <!-- Armazém Caruaru -->
        <div class="estoque-card" data-armazem="Caruaru">
          <h4>Armazém Caruaru</h4>
          
          <!-- Barra de busca específica para este armazém -->
          <div class="search-container" id="searchCaruaru">
            <input type="text" class="search-input" placeholder="Buscar por número do lote..." onkeyup="filtrarRemessas('Caruaru', this.value)">
          </div>
          
          <ul id="remessasCaruaru">
            <li class="sem-remessas">Carregando remessas...</li>
          </ul>
          <div class="estoque-actions">
            <button class="btn-adicionar" onclick="location.href='estoque2.html'">
              <i class="bi bi-plus-circle"></i> Adicionar Sementes
            </button>
            <button class="btn-buscar" onclick="toggleBusca('Caruaru')">
              <i class="bi bi-search"></i> Buscar Remessa
            </button>
          </div>
        </div>

        <!-- Armazém Petrolina -->
        <div class="estoque-card" data-armazem="Petrolina">
          <h4>Armazém Petrolina</h4>
          
          <!-- Barra de busca específica para este armazém -->
          <div class="search-container" id="searchPetrolina">
            <input type="text" class="search-input" placeholder="Buscar por número do lote..." onkeyup="filtrarRemessas('Petrolina', this.value)">
          </div>
          
          <ul id="remessasPetrolina">
            <li class="sem-remessas">Carregando remessas...</li>
          </ul>
          <div class="estoque-actions">
            <button class="btn-adicionar" onclick="location.href='estoque2.html'">
              <i class="bi bi-plus-circle"></i> Adicionar Sementes
            </button>
            <button class="btn-buscar" onclick="toggleBusca('Petrolina')">
              <i class="bi bi-search"></i> Buscar Remessa
            </button>
          </div>
        </div>

        <!-- Armazém Garanhuns -->
        <div class="estoque-card" data-armazem="Garanhuns">
          <h4>Armazém Garanhuns</h4>
          
          <!-- Barra de busca específica para este armazém -->
          <div class="search-container" id="searchGaranhuns">
            <input type="text" class="search-input" placeholder="Buscar por número do lote..." onkeyup="filtrarRemessas('Garanhuns', this.value)">
          </div>
          
          <ul id="remessasGaranhuns">
            <li class="sem-remessas">Carregando remessas...</li>
          </ul>
          <div class="estoque-actions">
            <button class="btn-adicionar" onclick="location.href='estoque2.html'">
              <i class="bi bi-plus-circle"></i> Adicionar Sementes
            </button>
            <button class="btn-buscar" onclick="toggleBusca('Garanhuns')">
              <i class="bi bi-search"></i> Buscar Remessa
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal para editar remessa -->
  <div class="modal fade" id="editarRemessaModal" tabindex="-1" aria-labelledby="editarRemessaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editarRemessaModalLabel">Editar Remessa</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editarRemessaForm">
            <input type="hidden" id="editarRemessaId" name="id">
            <input type="hidden" id="editarArmazem" name="armazem">
            <input type="hidden" id="editarLoteOriginal" name="loteOriginal">
            <div class="mb-3">
              <label for="editarLote" class="form-label">Número do Lote</label>
              <input type="text" class="form-control" id="editarLote" name="lote" required>
            </div>
            <div class="mb-3">
              <label for="editarTipo" class="form-label">Tipo de Semente</label>
              <select class="form-select" id="editarTipo" name="tipo" required>
                <option value="Milho">Milho</option>
                <option value="Feijão">Feijão</option>
                <option value="Soja">Soja</option>
                <option value="Arroz">Arroz</option>
                <option value="Sorgo">Sorgo</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editarQuantidade" class="form-label">Quantidade (kg)</label>
              <input type="number" class="form-control" id="editarQuantidade" name="quantidade" min="0" step="0.01" required>
            </div>
            <div class="mb-3">
              <label for="editarStatus" class="form-label">Status</label>
              <select class="form-select" id="editarStatus" name="status" required>
                <option value="Disponível">Disponível</option>
                <option value="Em trânsito">Em trânsito</option>
                <option value="Reservado">Reservado</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editarData" class="form-label">Data de Entrada</label>
              <input type="date" class="form-control" id="editarData" name="data_entrada" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnSalvarEdicao">
            <span class="loading" id="loadingEditar" style="display: none;"></span>
            <span id="textoBtnEditar">Salvar Alterações</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para detalhes da remessa -->
  <div class="modal fade" id="detalhesRemessaModal" tabindex="-1" aria-labelledby="detalhesRemessaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="detalhesRemessaModalLabel">Detalhes da Remessa</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="detalhesRemessaConteudo">
            <!-- Conteúdo será preenchido via JavaScript -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para deletar remessa -->
  <div class="modal fade" id="deletarRemessaModal" tabindex="-1" aria-labelledby="deletarRemessaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deletarRemessaModalLabel">Confirmar Exclusão</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Tem certeza que deseja excluir a remessa <span id="remessaDeletarLote"></span> do armazém <span id="armazemDeletarNome"></span>?</p>
          <p class="text-danger"><small>Esta ação não pode ser desfeita.</small></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirmarDeletarRemessa">
            <span class="loading" id="loadingDeletar" style="display: none;"></span>
            <span id="textoBtnDeletar">Excluir</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Configurações da API
    const API_BASE_URL = 'http://localhost:5000/api';

    // Função para alternar a sidebar
    const sidebar = document.getElementById("sidebar");
    const mainContent = document.getElementById("main-content");
    const toggleBtn = document.getElementById("toggle-btn");

    toggleBtn.addEventListener("click", () => {
      sidebar.classList.toggle("collapsed");
      mainContent.classList.toggle("expanded");
    });

    // Função para mostrar alerta
    function showAlert(message, type = 'success') {
      // Remove alertas existentes
      const existingAlert = document.querySelector('.custom-alert');
      if (existingAlert) {
        existingAlert.remove();
      }

      // Cria novo alerta
      const alertDiv = document.createElement('div');
      alertDiv.className = `custom-alert alert alert-${type} alert-dismissible fade show`;
      alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
      `;
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(alertDiv);
      
      // Remove automaticamente após 5 segundos
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, 5000);
    }

    // Carregar remessas ao abrir a página
    document.addEventListener('DOMContentLoaded', function() {
      carregarRemessas();
    });

    // Função para carregar todas as remessas do banco
    async function carregarRemessas() {
      try {
        const response = await fetch(`${API_BASE_URL}/listar-remessas`);
        const data = await response.json();

        if (data.success) {
          exibirRemessas(data.remessas);
        } else {
          showAlert('Erro ao carregar remessas', 'danger');
        }
      } catch (error) {
        console.error('Erro ao carregar remessas:', error);
        showAlert('Erro de conexão com o servidor', 'danger');
      }
    }

    // Função para exibir remessas nos armazéns correspondentes
    function exibirRemessas(remessas) {
      // Limpar listas existentes
      const armazens = ['Caruaru', 'Petrolina', 'Garanhuns'];
      armazens.forEach(armazem => {
        const lista = document.getElementById(`remessas${armazem}`);
        lista.innerHTML = '';
      });

      if (remessas.length === 0) {
        armazens.forEach(armazem => {
          const lista = document.getElementById(`remessas${armazem}`);
          lista.innerHTML = '<li class="sem-remessas">Nenhuma remessa encontrada</li>';
        });
        return;
      }

      // Agrupar remessas por armazém
      const remessasPorArmazem = {};
      armazens.forEach(armazem => {
        remessasPorArmazem[armazem] = remessas.filter(remessa => 
          remessa.armazem_vinculado.includes(armazem)
        );
      });

      // Exibir remessas em cada armazém
      armazens.forEach(armazem => {
        const lista = document.getElementById(`remessas${armazem}`);
        const remessasArmazem = remessasPorArmazem[armazem];

        if (remessasArmazem.length === 0) {
          lista.innerHTML = '<li class="sem-remessas">Nenhuma remessa neste armazém</li>';
          return;
        }

        remessasArmazem.forEach(remessa => {
          const item = document.createElement('li');
          item.className = 'estoque-item';
          item.setAttribute('data-lote', remessa.numero_lote);
          item.setAttribute('data-id', remessa.id);
          
          item.innerHTML = `
            <div class="remessa-info" onclick="mostrarDetalhesRemessa(${remessa.id})">
              <span class="remessa-lote">${remessa.numero_lote}</span>
              <span class="remessa-detalhes">${remessa.tipo_semente}: ${remessa.quantidade_kg} kg | Status: ${remessa.status}</span>
            </div>
            <div class="item-actions">
              <button class="btn-editar btn-sm" onclick="event.stopPropagation(); editarRemessa(${remessa.id})">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn-deletar btn-sm" onclick="event.stopPropagation(); deletarRemessa(${remessa.id}, '${remessa.numero_lote}', '${armazem}')">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          `;
          
          lista.appendChild(item);
        });
      });
    }

    // Função para mostrar/ocultar a barra de busca de um armazém específico
    function toggleBusca(armazem) {
      const searchContainer = document.getElementById(`search${armazem}`);
      searchContainer.style.display = searchContainer.style.display === 'block' ? 'none' : 'block';
      
      // Foca no campo de busca quando é exibido
      if (searchContainer.style.display === 'block') {
        searchContainer.querySelector('.search-input').focus();
      }
    }

    // Função para filtrar remessas por número de lote
    function filtrarRemessas(armazem, termo) {
      const listaRemessas = document.getElementById(`remessas${armazem}`);
      const itens = listaRemessas.querySelectorAll('.estoque-item');
      
      itens.forEach(item => {
        const lote = item.getAttribute('data-lote').toLowerCase();
        if (lote.includes(termo.toLowerCase())) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }

    // Função para mostrar detalhes da remessa
    async function mostrarDetalhesRemessa(id) {
      try {
        const response = await fetch(`${API_BASE_URL}/listar-remessas`);
        const data = await response.json();

        if (data.success) {
          const remessa = data.remessas.find(r => r.id === id);
          if (remessa) {
            document.getElementById('detalhesRemessaConteudo').innerHTML = `
              <div class="row">
                <div class="col-6">
                  <strong>Número do Lote:</strong>
                </div>
                <div class="col-6">
                  ${remessa.numero_lote}
                </div>
              </div>
              <div class="row mt-2">
                <div class="col-6">
                  <strong>Tipo de Semente:</strong>
                </div>
                <div class="col-6">
                  ${remessa.tipo_semente}
                </div>
              </div>
              <div class="row mt-2">
                <div class="col-6">
                  <strong>Quantidade:</strong>
                </div>
                <div class="col-6">
                  ${remessa.quantidade_kg} kg
                </div>
              </div>
              <div class="row mt-2">
                <div class="col-6">
                  <strong>Status:</strong>
                </div>
                <div class="col-6">
                  ${remessa.status}
                </div>
              </div>
              <div class="row mt-2">
                <div class="col-6">
                  <strong>Armazém:</strong>
                </div>
                <div class="col-6">
                  ${remessa.armazem_vinculado}
                </div>
              </div>
              <div class="row mt-2">
                <div class="col-6">
                  <strong>Data de Entrada:</strong>
                </div>
                <div class="col-6">
                  ${remessa.data_entrada}
                </div>
              </div>
              <div class="row mt-2">
                <div class="col-6">
                  <strong>Criado por:</strong>
                </div>
                <div class="col-6">
                  ${remessa.criado_por || 'Sistema'}
                </div>
              </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('detalhesRemessaModal'));
            modal.show();
          }
        }
      } catch (error) {
        console.error('Erro ao carregar detalhes:', error);
        showAlert('Erro ao carregar detalhes da remessa', 'danger');
      }
    }

    // Função para editar uma remessa
    async function editarRemessa(id) {
      try {
        const response = await fetch(`${API_BASE_URL}/listar-remessas`);
        const data = await response.json();

        if (data.success) {
          const remessa = data.remessas.find(r => r.id === id);
          if (remessa) {
            document.getElementById('editarRemessaId').value = remessa.id;
            document.getElementById('editarArmazem').value = remessa.armazem_vinculado;
            document.getElementById('editarLoteOriginal').value = remessa.numero_lote;
            document.getElementById('editarLote').value = remessa.numero_lote;
            document.getElementById('editarTipo').value = remessa.tipo_semente;
            document.getElementById('editarQuantidade').value = remessa.quantidade_kg;
            document.getElementById('editarStatus').value = remessa.status;
            document.getElementById('editarData').value = remessa.data_entrada;
            
            const modal = new bootstrap.Modal(document.getElementById('editarRemessaModal'));
            modal.show();
          }
        }
      } catch (error) {
        console.error('Erro ao carregar dados para edição:', error);
        showAlert('Erro ao carregar dados da remessa', 'danger');
      }
    }

    // Configurar evento de salvar edição
    document.getElementById('btnSalvarEdicao').addEventListener('click', salvarEdicaoRemessa);

    // Função para salvar a edição de uma remessa
    async function salvarEdicaoRemessa() {
      const id = document.getElementById('editarRemessaId').value;
      const lote = document.getElementById('editarLote').value;
      const tipo = document.getElementById('editarTipo').value;
      const quantidade = document.getElementById('editarQuantidade').value;
      const status = document.getElementById('editarStatus').value;
      const data_entrada = document.getElementById('editarData').value;
      const armazem = document.getElementById('editarArmazem').value;

      // Mostrar loading
      document.getElementById('loadingEditar').style.display = 'inline-block';
      document.getElementById('textoBtnEditar').textContent = 'Salvando...';
      document.getElementById('btnSalvarEdicao').disabled = true;

      try {
        // Aqui precisaríamos de um endpoint específico para editar remessas
        // Por enquanto, vou simular a edição (você precisará criar este endpoint no backend)
        const response = await fetch(`${API_BASE_URL}/editar-remessa/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            numero_lote: lote,
            tipo_semente: tipo,
            quantidade_kg: quantidade,
            status: status,
            data_entrada: data_entrada,
            armazem_vinculado: armazem
          })
        });

        const data = await response.json();

        if (data.success) {
          showAlert('Remessa atualizada com sucesso!');
          const modal = bootstrap.Modal.getInstance(document.getElementById('editarRemessaModal'));
          modal.hide();
          carregarRemessas(); // Recarregar a lista
        } else {
          showAlert(data.message || 'Erro ao atualizar remessa', 'danger');
        }
      } catch (error) {
        console.error('Erro ao atualizar remessa:', error);
        showAlert('Erro de conexão com o servidor', 'danger');
      } finally {
        // Restaurar botão
        document.getElementById('loadingEditar').style.display = 'none';
        document.getElementById('textoBtnEditar').textContent = 'Salvar Alterações';
        document.getElementById('btnSalvarEdicao').disabled = false;
      }
    }

    // Variáveis globais para deleção
    let remessaParaDeletar = null;

    // Função para preparar deleção de uma remessa
    function deletarRemessa(id, lote, armazem) {
      remessaParaDeletar = { id, lote, armazem };
      document.getElementById('remessaDeletarLote').textContent = lote;
      document.getElementById('armazemDeletarNome').textContent = armazem;
      
      const modal = new bootstrap.Modal(document.getElementById('deletarRemessaModal'));
      modal.show();
    }

    // Configurar evento de confirmação de deleção
    document.getElementById('confirmarDeletarRemessa').addEventListener('click', confirmarDelecaoRemessa);

    // Função para confirmar deleção
    async function confirmarDelecaoRemessa() {
      if (!remessaParaDeletar) return;

      // Mostrar loading
      document.getElementById('loadingDeletar').style.display = 'inline-block';
      document.getElementById('textoBtnDeletar').textContent = 'Excluindo...';
      document.getElementById('confirmarDeletarRemessa').disabled = true;

      try {
        // Aqui precisaríamos de um endpoint específico para deletar remessas
        // Por enquanto, vou simular a deleção (você precisará criar este endpoint no backend)
        const response = await fetch(`${API_BASE_URL}/deletar-remessa/${remessaParaDeletar.id}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
          showAlert('Remessa excluída com sucesso!');
          const modal = bootstrap.Modal.getInstance(document.getElementById('deletarRemessaModal'));
          modal.hide();
          carregarRemessas(); // Recarregar a lista
        } else {
          showAlert(data.message || 'Erro ao excluir remessa', 'danger');
        }
      } catch (error) {
        console.error('Erro ao excluir remessa:', error);
        showAlert('Erro de conexão com o servidor', 'danger');
      } finally {
        // Restaurar botão
        document.getElementById('loadingDeletar').style.display = 'none';
        document.getElementById('textoBtnDeletar').textContent = 'Excluir';
        document.getElementById('confirmarDeletarRemessa').disabled = false;
        remessaParaDeletar = null;
      }
    }
  </script>
</body>
</html>


