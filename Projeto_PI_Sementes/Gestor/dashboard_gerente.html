<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Semeia Web - Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --cor-primaria: #2e7d32;
      --cor-secundaria: #4caf50;
      --cor-fundo: #f4f6f5;
      --texto-principal: #333;
      --branco: #fff;
    }

    body {
      background-color: #f5f7f5;
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
    }

    /* ===== Sidebar ===== */
    .sidebar {
      width: 250px;
      height: 100vh;
      background-color: #146c43;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 10px;
      position: fixed;
      transition: width 0.3s ease;
      overflow: hidden;
    }

    .sidebar.collapsed { width: 80px; }

    .toggler {
      font-size: 1.5rem;
      cursor: pointer;
      color: #fff;
      align-self: flex-start;
      margin-bottom: 15px;
      margin-left: 5px;
      transition: all 0.3s ease;
    }

    .sidebar.collapsed .toggler {
      align-self: center;
      margin: 15px 0;
    }

    .toggler:hover { transform: scale(1.1); }

    .logo {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }

    .logo img { width: 45px; transition: all 0.3s ease; }
    .logo h4 { margin: 8px 0 0 0; color: #fff; transition: opacity 0.3s ease; }

    .sidebar.collapsed .logo h4 {
      opacity: 0;
      height: 0;
      overflow: hidden;
    }

    .profile {
      text-align: center;
      margin-bottom: 30px;
      transition: all 0.3s ease;
    }

    .profile img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 2px solid white;
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }

    .sidebar.collapsed .profile img {
      width: 45px;
      height: 45px;
    }

    .sidebar.collapsed .profile h6 {
      display: none;
    }

    .sidebar a {
      color: white;
      text-decoration: none;
      width: 100%;
      padding: 12px 20px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.3s ease, padding 0.3s ease;
    }

    .sidebar a:hover,
    .sidebar a.active { background-color: #0d5032; }

    .sidebar.collapsed a {
      justify-content: center;
      padding: 12px 0;
    }

    .sidebar.collapsed a span { display: none; }

    .logout {
      margin-top: auto;
      width: 100%;
      border-top: 1px solid rgba(255,255,255,0.2);
      padding-top: 15px;
    }

    .logout a {
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      border-radius: 10px;
      transition: background 0.3s ease;
    }

    .logout a:hover { background-color: #0d5032; }

    .sidebar.collapsed .logout a {
      justify-content: center;
      padding: 12px 0;
    }

    .sidebar.collapsed .logout a span { display: none; }

    /* ===== Main Content ===== */
    .main-content {
      margin-left: 250px;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transition: margin-left 0.3s ease, width 0.3s ease;
      width: calc(100% - 250px);
    }

    .sidebar.collapsed ~ .main-content {
      margin-left: 80px;
      width: calc(100% - 80px);
    }

    header {
      background-color: var(--branco);
      padding: 15px 25px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h4 { 
      margin: 0; 
      color: var(--texto-principal);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-info img {
      width: 35px;
      height: 35px;
      border-radius: 50%;
    }

    main {
      flex: 1;
      padding: 40px 25px;
      background-color: var(--cor-fundo);
    }

    /* ===== Cards e Conteúdo ===== */
    .row.g-4 > div {
      display: flex;
    }

    .card {
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      flex: 1;
      height: 100%;
      min-height: 320px;
    }

    /* ===== Melhorias em Alertas ===== */
    .alertas {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .alerta-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      background-color: #f8f9fa;
      padding: 10px 14px;
      border-radius: 8px;
      border-left: 5px solid transparent;
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    .alerta-item i {
      font-size: 1.2rem;
      margin-top: 3px;
    }

    .alerta-item:hover {
      background-color: #eef3ee;
    }

    .alerta-grave { border-left-color: #dc3545; }   /* Vermelho */
    .alerta-aviso { border-left-color: #ffc107; }   /* Amarelo */
    .alerta-ok { border-left-color: #28a745; }      /* Verde */

    /* ===== Sistema de Alertas CRUD ===== */
    .alertas-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .search-box {
      position: relative;
      margin-bottom: 15px;
    }

    .search-box input {
      padding-left: 35px;
    }

    .search-box i {
      position: absolute;
      left: 10px;
      top: 10px;
      color: #6c757d;
    }

    .alertas-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
    }

    .table-actions {
      display: flex;
      gap: 5px;
    }
  </style>
</head>
<body>

  <!-- ===== Sidebar ===== -->
  <div class="sidebar" id="sidebar">
    <i class="bi bi-list toggler" id="toggle-btn"></i>

    <div class="logo">
      <img src="img/logo2.png" alt="Semeia Web">
      <h4>Semeia Web</h4>
    </div>

    <div class="profile">
      <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Usuário">
      <h6>Annatoli Karpov Bartolomeu</h6>
    </div>

    <a href="dashboard_gerente.html" class="active"><i class="bi bi-house-fill"></i><span>Início</span></a>
    <a href="estoque.html"><i class="bi bi-box-seam"></i><span>Estoque</span></a>
    <a href="distribuicao.html"><i class="bi bi-truck"></i><span>Distribuição</span></a>
    <a href="relatorios.html"><i class="bi bi-bar-chart-line"></i><span>Relatórios</span></a>
    <a href="usuarios.html"><i class="bi bi-people"></i><span>Usuários</span></a>
    <a href="notificacoes.html"><i class="bi bi-bell"></i><span>Notificações</span></a>
    <a href="configuracao.html"><i class="bi bi-gear"></i><span>Configurações</span></a>

    <div class="logout">
      <a href="../login.html"><i class="bi bi-box-arrow-right"></i><span>Sair</span></a>
    </div>
  </div>

  <!-- ===== Conteúdo Principal ===== -->
  <div class="main-content" id="main-content">
    <header>
      <h4>Painel do Gestor</h4>
      <div class="user-info">
        <span>Bem-vindo, Annatoli</span>
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Usuário">
      </div>
    </header>

    <main>
      <div class="container-fluid">
        <div class="row g-4">
          <!-- Panorama Geral -->
          <div class="col-lg-6">
            <div class="card p-3">
              <h6 class="fw-bold">Panorama Geral</h6>
              <img src="img/agreste.png" alt="Gráfico 1" class="img-fluid rounded">
              <p class="mt-2"><b>Total de sementes disponíveis:</b> 12.450 kg<br>
              <b>Unidades participantes:</b> 15 regionais</p>
            </div>
          </div>

          <!-- Entregas em Andamento (RESTAURADO) -->
          <div class="col-lg-6">
            <div class="card p-3">
              <h6 class="fw-bold">Entregas em Andamento</h6>
              <img src="img/andamento.webp" alt="Gráfico 2" class="img-fluid rounded">
              <p class="mt-2"><b>Em execução:</b> 32<br>
              <b>Concluídas este mês:</b> 120</p>
            </div>
          </div>

          <!-- Sistema de Alertas CRUD (CONECTADO AO BANCO) -->
          <div class="col-lg-6">
            <div class="card p-3">
              <div class="alertas-header">
                <h6 class="fw-bold mb-0">Sistema de Alertas</h6>
                <button class="btn btn-success btn-sm" onclick="criarNovoAlerta()">
                  <i class="bi bi-plus-circle"></i> Novo Alerta
                </button>
              </div>
              
              <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" class="form-control" id="pesquisarAlerta" placeholder="Pesquisar alertas...">
              </div>
              
              <div class="alertas" id="lista-alertas">
                <!-- Alertas serão carregados dinamicamente do banco -->
                <div class="text-center text-muted py-4">
                  <i class="bi bi-hourglass-split"></i><br>
                  Carregando alertas...
                </div>
              </div>
            </div>
          </div>

          <!-- Distribuição Geográfica -->
          <div class="col-lg-6">
            <div class="card p-3">
              <h6 class="fw-bold">Distribuição Geográfica</h6>
              <img src="img/mapa.png" alt="Mapa" class="img-fluid rounded">
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal para Criar/Editar Alerta -->
  <div class="modal fade" id="modalAlerta" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalAlertaTitulo">Criar Novo Alerta</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formAlerta">
            <input type="hidden" id="alertaId">
            <div class="mb-3">
              <label class="form-label">Tipo de Semente *</label>
              <select class="form-select" id="tipoSemente" required>
                <option value="">Selecione...</option>
                <option value="Milho">Milho</option>
                <option value="Feijão">Feijão</option>
                <option value="Arroz">Arroz</option>
                <option value="Mandioca">Mandioca</option>
                <option value="Abóbora">Abóbora</option>
                <option value="Inhame">Inhame</option>
                <option value="Tomate">Tomate</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Localização *</label>
              <input type="text" class="form-control" id="localizacao" placeholder="Ex: Caruaru, Garanhuns..." required>
            </div>
            <div class="mb-3">
              <label class="form-label">Nível de Alerta *</label>
              <select class="form-select" id="nivelAlerta" required>
                <option value="grave">Grave (Vermelho)</option>
                <option value="aviso">Aviso (Amarelo)</option>
                <option value="ok">OK (Verde)</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Mensagem do Alerta *</label>
              <textarea class="form-control" id="mensagemAlerta" rows="3" required></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" onclick="salvarAlerta()">Salvar Alerta</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Controle da Sidebar
    const sidebar = document.getElementById("sidebar");
    const mainContent = document.getElementById("main-content");
    const toggleBtn = document.getElementById("toggle-btn");

    toggleBtn.addEventListener("click", () => {
      sidebar.classList.toggle("collapsed");
      mainContent.classList.toggle("expanded");
    });

    // Carregar dados iniciais
    document.addEventListener('DOMContentLoaded', function() {
      carregarAlertas();
      configurarPesquisa();
    });

    // Funções para Sistema de Alertas (CRUD) - CONECTADO AO BANCO
    function configurarPesquisa() {
      const pesquisaInput = document.getElementById('pesquisarAlerta');
      pesquisaInput.addEventListener('input', function() {
        const termo = this.value.toLowerCase();
        const alertas = document.querySelectorAll('#lista-alertas .alerta-item');
        
        alertas.forEach(alerta => {
          const texto = alerta.textContent.toLowerCase();
          alerta.style.display = texto.includes(termo) ? 'flex' : 'none';
        });
      });
    }

    async function carregarAlertas() {
  try {
    const response = await fetch('/api/alertas');
    const data = await response.json();
    
    console.log('Dados recebidos da API:', data); // Para debug
    
    const container = document.getElementById('lista-alertas');
    
    if (data.success && data.alertas && data.alertas.length > 0) {
      container.innerHTML = '';
      
      data.alertas.forEach(alerta => {
        console.log('Alerta individual:', alerta); // Para debug
        
        const alertaDiv = document.createElement('div');
        alertaDiv.className = `alerta-item alerta-${alerta.nivel}`;
        
        // Formatar a data corretamente
        let dataFormatada = 'Data não disponível';
        if (alerta.data_criacao) {
          try {
            const dataObj = new Date(alerta.data_criacao);
            if (!isNaN(dataObj.getTime())) {
              dataFormatada = dataObj.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              });
            }
          } catch (e) {
            dataFormatada = alerta.data_criacao; // Usa o valor original se der erro
          }
        }
        
        alertaDiv.innerHTML = `
          <i class="bi ${getAlertaIcon(alerta.nivel)} ${getAlertaColor(alerta.nivel)}"></i>
          <div class="flex-grow-1">
            <span><b>${alerta.tipo_semente} - ${alerta.localizacao}:</b> ${alerta.mensagem}</span>
            <div class="d-flex justify-content-between align-items-center mt-1">
              <small class="text-muted">Criado em: ${dataFormatada}</small>
              <div class="table-actions">
                <button class="btn btn-warning btn-sm" onclick="editarAlerta(${alerta.id})">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick="deletarAlerta(${alerta.id})">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
        container.appendChild(alertaDiv);
      });
    } else {
      container.innerHTML = `
        <div class="text-center text-muted py-4">
          <i class="bi bi-info-circle"></i><br>
          Nenhum alerta encontrado
        </div>
      `;
    }
  } catch (error) {
    console.error('Erro ao carregar alertas:', error);
    document.getElementById('lista-alertas').innerHTML = `
      <div class="text-center text-danger py-4">
        <i class="bi bi-exclamation-triangle"></i><br>
        Erro ao carregar alertas: ${error.message}
      </div>
    `;
  }
}

// Função para formatar a data corretamente
function formatarData(dataString) {
  if (!dataString) return 'Data não disponível';
  
  try {
    // Se já é uma string formatada, retorna como está
    if (typeof dataString === 'string' && dataString.includes('-')) {
      const data = new Date(dataString);
      if (isNaN(data.getTime())) {
        // Se não conseguiu converter, retorna a string original
        return dataString;
      }
      return data.toLocaleDateString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    return dataString;
  } catch (error) {
    console.error('Erro ao formatar data:', error, dataString);
    return 'Data inválida';
  }
}

    function getAlertaIcon(nivel) {
      switch(nivel) {
        case 'grave': return 'bi-x-circle-fill';
        case 'aviso': return 'bi-exclamation-triangle-fill';
        case 'ok': return 'bi-check-circle-fill';
        default: return 'bi-info-circle';
      }
    }

    function getAlertaColor(nivel) {
      switch(nivel) {
        case 'grave': return 'text-danger';
        case 'aviso': return 'text-warning';
        case 'ok': return 'text-success';
        default: return 'text-info';
      }
    }

    function criarNovoAlerta() {
      document.getElementById('modalAlertaTitulo').textContent = 'Criar Novo Alerta';
      document.getElementById('formAlerta').reset();
      document.getElementById('alertaId').value = '';
      
      const modal = new bootstrap.Modal(document.getElementById('modalAlerta'));
      modal.show();
    }

    async function salvarAlerta() {
      const tipoSemente = document.getElementById('tipoSemente').value;
      const localizacao = document.getElementById('localizacao').value;
      const nivelAlerta = document.getElementById('nivelAlerta').value;
      const mensagem = document.getElementById('mensagemAlerta').value;
      const alertaId = document.getElementById('alertaId').value;

      // Validação básica
      if (!tipoSemente || !localizacao || !mensagem) {
        alert('Por favor, preencha todos os campos obrigatórios.');
        return;
      }

      const alertaData = {
        tipo_semente: tipoSemente,
        localizacao: localizacao,
        nivel: nivelAlerta,
        mensagem: mensagem
      };

      try {
        let response;
        if (alertaId) {
          // Editar alerta existente
          response = await fetch(`/api/alertas/${alertaId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(alertaData)
          });
        } else {
          // Criar novo alerta
          response = await fetch('/api/alertas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(alertaData)
          });
        }

        const data = await response.json();
        
        if (data.success) {
          alert(data.message);
          bootstrap.Modal.getInstance(document.getElementById('modalAlerta')).hide();
          carregarAlertas();
        } else {
          alert('Erro: ' + data.message);
        }
      } catch (error) {
        console.error('Erro ao salvar alerta:', error);
        alert('Erro ao salvar alerta');
      }
    }

    async function editarAlerta(id) {
  try {
    const response = await fetch('/api/alertas');
    const data = await response.json();
    
    console.log('Dados recebidos para edição:', data); // Debug
    
    if (data.success) {
      const alerta = data.alertas.find(a => a.id === id);
      console.log('Alerta encontrado:', alerta); // Debug
      
      if (alerta) {
        document.getElementById('modalAlertaTitulo').textContent = 'Editar Alerta';
        document.getElementById('alertaId').value = alerta.id;
        document.getElementById('tipoSemente').value = alerta.tipo_semente;
        document.getElementById('localizacao').value = alerta.localizacao;
        document.getElementById('nivelAlerta').value = alerta.nivel;
        document.getElementById('mensagemAlerta').value = alerta.mensagem;
        
        const modal = new bootstrap.Modal(document.getElementById('modalAlerta'));
        modal.show();
      }
    }
  } catch (error) {
    console.error('Erro ao carregar alerta para edição:', error);
    alert('Erro ao carregar alerta');
  }
}

    async function deletarAlerta(id) {
      if (confirm('Tem certeza que deseja excluir este alerta?')) {
        try {
          const response = await fetch(`/api/alertas/${id}`, { 
            method: 'DELETE' 
          });
          const data = await response.json();
          
          if (data.success) {
            alert(data.message);
            carregarAlertas();
          } else {
            alert('Erro: ' + data.message);
          }
        } catch (error) {
          console.error('Erro ao deletar alerta:', error);
          alert('Erro ao deletar alerta');
        }
      }
    }

    // Expor funções globais para os botões
    window.criarNovoAlerta = criarNovoAlerta;
    window.salvarAlerta = salvarAlerta;
    window.editarAlerta = editarAlerta;
    window.deletarAlerta = deletarAlerta;
  </script>
</body>
</html>